
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>صانع صور الشورتس الإخبارية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700;900&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-main: #1a1d21;
      --bg-panel: #24282f;
      --bg-control: #3a4049;
      --border-color: #4a5059;
      --text-primary: #f0f2f5;
      --text-secondary: #a0a7b3;
      --accent-primary: #2dd4bf;
      --accent-hover: #26bba9;
      --accent-gradient-from: #2dd4bf;
      --accent-gradient-to: #3b82f6;
      --red-heart: #ef4444;
      --yellow-star: #facc15;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      direction: rtl;
    }

    main {
      min-height: 100vh;
      padding: 1rem;
    }
    @media (min-width: 640px) { main { padding: 1.5rem; } }
    @media (min-width: 1024px) { main { padding: 2rem; } }

    .container {
      max-width: 80rem;
      margin-left: auto;
      margin-right: auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .main-title {
      font-size: 2.25rem;
      font-weight: 800;
      background-image: linear-gradient(to right, var(--accent-gradient-from), var(--accent-gradient-to));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    @media (min-width: 640px) { .main-title { font-size: 3rem; } }

    .subtitle {
      margin-top: 0.5rem;
      font-size: 1.125rem;
      color: var(--text-secondary);
    }

    .flex-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    @media (min-width: 1024px) { .flex-container { flex-direction: row; } }

    /* Controls Panel */
    .controls-panel {
      width: 100%;
      background-color: var(--bg-panel);
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid var(--border-color);
    }
    @media (min-width: 1024px) { .controls-panel { width: 33.333333%; } }

    .panel-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .space-y-3 > *:not(:last-child) { margin-bottom: 0.75rem; }
    .space-y-4 > *:not(:last-child) { margin-bottom: 1rem; }

    /* Accordion */
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details[open] > summary svg { transform: rotate(180deg); }

    .accordion-item {
      background-color: transparent;
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      overflow: hidden;
      transition: background-color 0.2s;
    }
    details[open].accordion-item {
      background-color: rgba(0,0,0,0.1);
    }
    .accordion-summary {
      padding: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-summary svg { transition: transform 0.2s; color: var(--text-secondary); }

    .accordion-content {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      background-color: var(--bg-control);
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      padding: 0.75rem;
      color: var(--text-primary);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.4);
    }
    .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .input-with-spinner { position: relative; }
    .input-with-spinner .spinner { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); height: 1.25rem; width: 1.25rem; }
    .input-with-spinner .form-input { padding-left: 2.5rem; }

    .color-input { width: 100%; height: 2.5rem; padding: 0.25rem; background-color: transparent; border: 1px solid var(--border-color); border-radius: 0.375rem; cursor: pointer; }

    .range-input { width: 100%; height: 0.5rem; background-color: #4b5563; border-radius: 0.5rem; -webkit-appearance: none; appearance: none; cursor: pointer; }
    .range-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 50%; background: var(--accent-primary); cursor: pointer; }

    .file-input-label {
      width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 0.5rem; background-color: var(--bg-control); color: var(--text-secondary);
      font-weight: 700; padding: 1rem; border-radius: 0.375rem; cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s; border: 2px dashed var(--border-color);
    }
    .file-input-label.dragover, .file-input-label:hover { background-color: rgba(45, 212, 191, 0.1); border-color: var(--accent-primary); }
    .file-input-label-small { padding: 0.5rem 1rem; flex-direction: row; }
    
    .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .btn {
      padding: 0.75rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem;
      transition: all 0.2s; border: 1px solid var(--border-color);
      color: var(--text-secondary); background-color: var(--bg-control); cursor: pointer;
    }
    .btn:hover { background-color: var(--border-color); color: var(--text-primary); }
    .btn.active {
      background-color: var(--accent-primary); color: var(--bg-main); font-weight: 700; border-color: var(--accent-primary);
    }

    .hidden { display: none !important; }

    /* Preview Panel */
    .preview-panel-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    @media (min-width: 1024px) { .preview-panel-wrapper { width: 66.666667%; } }

    #image-preview {
      width: 100%; max-width: 405px; aspect-ratio: 9 / 16; overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      display: flex; flex-direction: column; justify-content: flex-start;
      padding: 1.5rem; gap: 0.75rem; transition: all 0.5s ease-in-out;
      border-radius: 0;
    }
    @media (min-width: 640px) { #image-preview { padding: 2rem; } }

    .preview-section-box {
      background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
      padding: 0.75rem; border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #preview-headline, #preview-newsBody { text-align: center; width: 100%; word-wrap: break-word; }
    #preview-headline { font-weight: 900; line-height: 1.2; }
    #preview-newsBody { font-weight: 500; line-height: 1.5; }

    .divider { height: 1px; width: 50%; margin: 0 auto; background-color: rgba(45, 212, 191, 0.3); }

    .main-image-container {
      position: relative; width: 100%; margin: auto 0; flex-grow: 1;
      border-radius: 0.75rem; overflow: hidden;
      background-color: rgba(55, 65, 81, 0.3);
    }

    #preview-mainImage { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: all 0.3s; }
    #preview-mainImage-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); text-align: center; padding: 1rem; }

    #preview-logo-container {
      position: absolute; display: flex; align-items: center; justify-content: center;
      background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.15); transition: all 0.3s;
    }
    #preview-logo-container.top-right { top: 1rem; right: 1rem; }
    #preview-logo-container.top-left { top: 1rem; left: 1rem; }
    #preview-logo-container.bottom-right { bottom: 1rem; right: 1rem; }
    #preview-logo-container.bottom-left { bottom: 1rem; left: 1rem; }

    #preview-logo { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }

    .cta-container { margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 1rem; color: white; font-weight: 600; font-size: 0.875rem; padding-top: 1rem; }
    .cta-item { display: flex; align-items: center; gap: 0.375rem; }
    .cta-divider { height: 1.25rem; width: 1px; background-color: rgba(255, 255, 255, 0.3); }

    /* Export Button & Spinner */
    .export-btn {
      margin-top: 1.5rem; width: 100%; max-width: 405px;
      background-image: linear-gradient(to right, var(--accent-gradient-to), var(--accent-gradient-from));
      color: var(--bg-main); font-weight: 700;
      padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-size: 1.125rem;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; align-items: center; justify-content: center;
      border: none; cursor: pointer;
    }
    .export-btn:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .export-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .export-btn svg:not(.spinner) { height: 1.5rem; width: 1.5rem; margin-left: 0.5rem; }

    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    #export-button-loading .spinner { margin-left: -0.25rem; margin-right: 0.75rem; height: 1.25rem; width: 1.25rem; }
    
    /* Palette buttons */
    .palette-btn {
      display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.5rem;
      border-radius: 0.5rem; transition: background-color 0.15s;
      border: 1px solid transparent; background-color: transparent; color: var(--text-primary);
      text-align: right; font-size: 0.875rem;
    }
    .palette-btn:hover { background-color: var(--bg-control); }
    .palette-btn.active { background-color: rgba(45, 212, 191, 0.15); border-color: var(--accent-primary); }
    .palette-color-box { width: 2rem; height: 2rem; border-radius: 0.375rem; border: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; }

    .control-grid { 
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 1rem; 
    }
    @media (min-width: 480px) {
        .control-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    .grid-col-span-2 { grid-column: span 2; }
  </style>
</head>
<body>
  <main>
    <div class="container">
      <header>
        <h1 class="main-title"> صانع صور الشورتس الإخبارية </h1>
        <p class="subtitle"> أنشئ صورًا احترافية وجذابة لفيديوهاتك القصيرة بسهولة. </p>
      </header>

      <div class="flex-container">
        <!-- Controls Panel -->
        <div class="controls-panel">
          <h2 class="panel-title">لوحة التحكم</h2>
          
          <div class="space-y-3">
            <!-- Accordion: Content -->
            <details class="accordion-item" open>
              <summary class="accordion-summary">
                <span>المحتوى</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </summary>
              <div class="accordion-content space-y-4">
                <div>
                  <label for="headline-input" class="form-label">عنوان الخبر</label>
                  <input type="text" id="headline-input" class="form-input">
                </div>
                <div>
                  <label for="newsBody-input" class="form-label">متن الخبر</label>
                  <textarea id="newsBody-input" rows="4" class="form-textarea"></textarea>
                </div>
                 <div>
                  <label for="mainImage-input" id="mainImage-drop-area" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                    <span>اسحب الصورة هنا أو انقر</span>
                  </label>
                  <input type="file" id="mainImage-input" accept="image/png, image/jpeg, image/webp" class="hidden">
                  <div class="text-center text-sm text-gray-400 my-2">أو</div>
                  <div class="input-with-spinner">
                     <svg id="mainImage-url-spinner" class="spinner hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <input type="text" id="mainImage-url-input" class="form-input" placeholder="الصق رابط الصورة هنا...">
                  </div>
                </div>
              </div>
            </details>
            
            <!-- Accordion: Text Styling -->
             <details class="accordion-item">
              <summary class="accordion-summary">
                <span>تصميم النصوص</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </summary>
              <div class="accordion-content space-y-4">
                <div class="control-grid">
                  <div class="grid-col-span-2">
                    <label for="fontFamily-input" class="form-label">نوع الخط</label>
                    <select id="fontFamily-input" class="form-select">
                      <option value="Cairo">Cairo</option>
                      <option value="Tajawal">Tajawal</option>
                      <option value="Almarai">Almarai</option>
                    </select>
                  </div>
                  <div>
                      <label for="headlineColor-input" class="form-label">لون العنوان</label>
                      <input type="color" id="headlineColor-input" class="color-input">
                  </div>
                  <div>
                      <label for="newsBodyColor-input" class="form-label">لون المتن</label>
                      <input type="color" id="newsBodyColor-input" class="color-input">
                  </div>
                </div>
                <div>
                    <label for="headlineSize-input" class="form-label">حجم العنوان (<span id="headlineSize-value">40</span>px)</label>
                    <input type="range" id="headlineSize-input" min="20" max="80" class="range-input">
                </div>
                <div>
                    <label for="newsBodySize-input" class="form-label">حجم المتن (<span id="newsBodySize-value">20</span>px)</label>
                    <input type="range" id="newsBodySize-input" min="12" max="40" class="range-input">
                </div>
              </div>
            </details>

            <!-- Accordion: Logo Styling -->
            <details class="accordion-item">
              <summary class="accordion-summary">
                <span>تصميم الشعار</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </summary>
              <div class="accordion-content space-y-4">
                <div>
                   <label for="logoImage-input" class="file-input-label file-input-label-small">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    <span>تغيير الشعار</span>
                  </label>
                  <input type="file" id="logoImage-input" accept="image/png, image/jpeg, image/webp" class="hidden">
                  <div class="text-center text-sm text-gray-400 my-2">أو</div>
                   <div class="input-with-spinner">
                     <svg id="logo-url-spinner" class="spinner hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <input type="text" id="logo-url-input" class="form-input" placeholder="الصق رابط الشعار هنا...">
                  </div>
                </div>
                <div>
                  <label for="logoSize-input" class="form-label">حجم الشعار (<span id="logoSize-value">80</span>px)</label>
                  <input type="range" id="logoSize-input" min="40" max="150" class="range-input">
                </div>
                <div>
                  <label class="form-label">موضع الشعار</label>
                  <div class="btn-group" id="logoPosition-buttons">
                    <button data-position="top-right" class="btn active">أعلى اليمين</button>
                    <button data-position="top-left" class="btn">أعلى اليسار</button>
                    <button data-position="bottom-right" class="btn">أسفل اليمين</button>
                    <button data-position="bottom-left" class="btn">أسفل اليسار</button>
                  </div>
                </div>
              </div>
            </details>

            <!-- Accordion: Background Palettes -->
             <details class="accordion-item">
              <summary class="accordion-summary">
                <span>تصميم الخلفية</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </summary>
              <div id="palettes-container" class="accordion-content space-y-2">
                <!-- Palettes will be dynamically inserted here -->
              </div>
            </details>

          </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel-wrapper">
          <div id="image-preview">
            <div class="preview-section-box">
              <h2 id="preview-headline"></h2>
            </div>
            <div class="divider"></div>
            <div class="main-image-container">
                 <img id="preview-mainImage" crossorigin="anonymous" alt="News image" class="preview-main-image">
                 <div id="preview-logo-container" class="logo-container">
                     <img id="preview-logo" crossorigin="anonymous" alt="Logo" class="preview-logo">
                 </div>
                 <div id="preview-mainImage-placeholder" class="main-image-placeholder hidden">
                     <span>اختر صورة للخبر</span>
                  </div>
            </div>
            <div class="divider"></div>
            <div class="preview-section-box">
              <p id="preview-newsBody"></p>
            </div>
            <div class="cta-container">
                <div class="cta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="color:var(--red-heart);" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                    <span style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);">إعجاب</span>
                </div>
                <div class="cta-divider"></div>
                <div class="cta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="color:var(--yellow-star);" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    <span style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);">اشتراك</span>
                </div>
            </div>
          </div>
          <button id="export-button" class="export-btn">
              <span id="export-button-content">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span>تصدير الصورة</span>
              </span>
              <span id="export-button-loading" class="hidden">
                 <svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>جاري التصدير...</span>
              </span>
          </button>
        </div>
      </div>
    </div>
  </main>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const state = {
        headline: 'هنا يكتب عنوان الخبر الرئيسي',
        newsBody: 'تفاصيل موجزة عن الخبر لجذب المشاهد. يجب أن تكون قصيرة وواضحة.',
        mainImageUrl: 'https://picsum.photos/720/720',
        logoImageUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48cGF0aCBkPSJNMTIgMjJWMk0yIDEyaDIwTTUuNSAxOC51QTkgOSAwIDAgMCAxMiAyMiA5IDkgMCAwIDAgMTguNSA1LjUiLz48cGF0aCBkPSJNNTUuNSA1LjVBNyA3IDAgMCAxIDEyIDIgNyA3IDAgMCAxIDE4LjUgMTguNSIvPjwvc3ZnPg==',
        mainImageBlobUrl: null,
        logoImageBlobUrl: null,
        headlineColor: '#FFFFFF',
        headlineSize: 40,
        newsBodyColor: '#E0E0E0',
        newsBodySize: 20,
        logoPosition: 'top-right',
        logoSize: 80,
        fontFamily: 'Cairo',
        isExporting: false,
        activePalette: null,
        isMainImageLoading: false,
        isLogoLoading: false,
    };

    const palettes = [
        { name: 'فجر المحيط الهادئ', css: 'linear-gradient(to right top, #051937, #004d7a, #008793, #00bf72, #a8eb12)' },
        { name: 'أضواء الشفق القطبي', css: 'linear-gradient(to right top, #0f0c29, #3a416a, #76788b, #b7b7a4, #fdf8f4)' },
        { name: 'نيون مدينة المستقبل', css: 'linear-gradient(45deg, #FF00FF 0%, #00FFFF 100%)' },
        { name: 'عمق الغابة المطيرة', css: 'linear-gradient(to right top, #003300, #005000, #006b00, #008900, #00a800)' },
        { name: 'صحراء المغرب', css: 'linear-gradient(to right top, #6b2e0f, #944618, #be6323, #eb8230, #ff9f3f)' },
        { name: 'هندسة الجليد', css: 'linear-gradient(to right top, #74ebd5, #9face6)' },
        { name: 'نار التنين', css: 'linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%)' },
        { name: 'هدوء منتصف الليل', css: 'linear-gradient(to right, #2c3e50, #000000)' },
        { name: 'كهف الكريستال', css: 'linear-gradient(135deg, #1b0042 0%, #52006A 100%)' },
        { name: 'صيف استوائي', css: 'linear-gradient(to right top, #00b09b, #96c93d)' },
        { name: 'سيان حيوي', css: 'linear-gradient(45deg, #004d40 0%, #009688 100%)' }
    ];
    state.activePalette = palettes[0];

    const dom = {
        headlineInput: document.getElementById('headline-input'),
        newsBodyInput: document.getElementById('newsBody-input'),
        mainImageInput: document.getElementById('mainImage-input'),
        mainImageUrlInput: document.getElementById('mainImage-url-input'),
        mainImageUrlSpinner: document.getElementById('mainImage-url-spinner'),
        mainImageDropArea: document.getElementById('mainImage-drop-area'),
        fontFamilyInput: document.getElementById('fontFamily-input'),
        headlineColorInput: document.getElementById('headlineColor-input'),
        newsBodyColorInput: document.getElementById('newsBodyColor-input'),
        headlineSizeInput: document.getElementById('headlineSize-input'),
        newsBodySizeInput: document.getElementById('newsBodySize-input'),
        logoImageInput: document.getElementById('logoImage-input'),
        logoUrlInput: document.getElementById('logo-url-input'),
        logoUrlSpinner: document.getElementById('logo-url-spinner'),
        logoSizeInput: document.getElementById('logoSize-input'),
        logoPositionButtons: document.getElementById('logoPosition-buttons'),
        palettesContainer: document.getElementById('palettes-container'),
        exportButton: document.getElementById('export-button'),
        exportButtonContent: document.getElementById('export-button-content'),
        exportButtonLoading: document.getElementById('export-button-loading'),
        headlineSizeValue: document.getElementById('headlineSize-value'),
        newsBodySizeValue: document.getElementById('newsBodySize-value'),
        logoSizeValue: document.getElementById('logoSize-value'),
        imagePreview: document.getElementById('image-preview'),
        previewHeadline: document.getElementById('preview-headline'),
        previewNewsBody: document.getElementById('preview-newsBody'),
        previewMainImage: document.getElementById('preview-mainImage'),
        previewMainImagePlaceholder: document.getElementById('preview-mainImage-placeholder'),
        previewLogoContainer: document.getElementById('preview-logo-container'),
        previewLogo: document.getElementById('preview-logo')
    };
    
    function updatePreview() {
        dom.previewHeadline.textContent = state.headline;
        dom.previewNewsBody.textContent = state.newsBody;

        const imageUrl = state.mainImageBlobUrl || state.mainImageUrl;
        if (imageUrl) {
            dom.previewMainImage.src = imageUrl;
            dom.previewMainImage.classList.remove('hidden');
            dom.previewMainImagePlaceholder.classList.add('hidden');
        } else {
            dom.previewMainImage.src = '';
            dom.previewMainImage.classList.add('hidden');
            dom.previewMainImagePlaceholder.classList.remove('hidden');
        }

        const logoUrl = state.logoImageBlobUrl || state.logoImageUrl;
        if (logoUrl) {
            dom.previewLogo.src = logoUrl;
            dom.previewLogoContainer.classList.remove('hidden');
        } else {
            dom.previewLogoContainer.classList.add('hidden');
        }
        
        dom.imagePreview.style.fontFamily = state.fontFamily;
        dom.previewHeadline.style.color = state.headlineColor;
        dom.previewHeadline.style.fontSize = `${state.headlineSize}px`;
        dom.previewNewsBody.style.color = state.newsBodyColor;
        dom.previewNewsBody.style.fontSize = `${state.newsBodySize}px`;
        
        dom.previewLogoContainer.className = 'logo-container'; // Reset classes
        dom.previewLogoContainer.classList.add('absolute', 'flex', 'items-center', 'justify-center', state.logoPosition);
        dom.previewLogoContainer.style.width = `${state.logoSize}px`;
        dom.previewLogoContainer.style.height = `${state.logoSize}px`;
        
        if (state.activePalette) {
            dom.imagePreview.style.background = state.activePalette.css;
        }

        dom.mainImageUrlSpinner.classList.toggle('hidden', !state.isMainImageLoading);
        dom.mainImageUrlInput.disabled = state.isMainImageLoading;
        dom.logoUrlSpinner.classList.toggle('hidden', !state.isLogoLoading);
        dom.logoUrlInput.disabled = state.isLogoLoading;
    }

    function setupEventListeners() {
        dom.headlineInput.addEventListener('input', (e) => { state.headline = e.target.value; updatePreview(); });
        dom.newsBodyInput.addEventListener('input', (e) => { state.newsBody = e.target.value; updatePreview(); });
        dom.fontFamilyInput.addEventListener('change', (e) => { state.fontFamily = e.target.value; updatePreview(); });
        dom.headlineColorInput.addEventListener('input', (e) => { state.headlineColor = e.target.value; updatePreview(); });
        dom.newsBodyColorInput.addEventListener('input', (e) => { state.newsBodyColor = e.target.value; updatePreview(); });

        const rangeInputs = [
            { input: dom.headlineSizeInput, stateKey: 'headlineSize', label: dom.headlineSizeValue },
            { input: dom.newsBodySizeInput, stateKey: 'newsBodySize', label: dom.newsBodySizeValue },
            { input: dom.logoSizeInput, stateKey: 'logoSize', label: dom.logoSizeValue },
        ];
        rangeInputs.forEach(({input, stateKey, label}) => {
            input.addEventListener('input', (e) => {
                const value = Number(e.target.value);
                state[stateKey] = value;
                if (label) label.textContent = value;
                updatePreview();
            });
        });

        dom.mainImageInput.addEventListener('change', (e) => handleFile(e.target.files[0], 'main'));
        dom.logoImageInput.addEventListener('change', (e) => handleFile(e.target.files[0], 'logo'));
        dom.mainImageUrlInput.addEventListener('change', (e) => handleUrl(e.target.value, 'main'));
        dom.logoUrlInput.addEventListener('change', (e) => handleUrl(e.target.value, 'logo'));

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dom.mainImageDropArea.addEventListener(eventName, e => e.preventDefault()));
        ['dragenter', 'dragover'].forEach(eventName => dom.mainImageDropArea.addEventListener(eventName, () => dom.mainImageDropArea.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(eventName => dom.mainImageDropArea.addEventListener(eventName, () => dom.mainImageDropArea.classList.remove('dragover')));
        dom.mainImageDropArea.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file, 'main');
            }
        });

        dom.logoPositionButtons.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.position) {
                state.logoPosition = button.dataset.position;
                dom.logoPositionButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                updatePreview();
            }
        });

        dom.palettesContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.name) {
                state.activePalette = palettes.find(p => p.name === button.dataset.name);
                dom.palettesContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                updatePreview();
            }
        });

        dom.exportButton.addEventListener('click', exportImage);
        window.addEventListener('beforeunload', cleanup);
    }

    function handleFile(file, type) {
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (type === 'main') {
                state.mainImageUrl = e.target.result;
                if (state.mainImageBlobUrl) URL.revokeObjectURL(state.mainImageBlobUrl);
                state.mainImageBlobUrl = null;
                dom.mainImageUrlInput.value = '';
            } else {
                state.logoImageUrl = e.target.result;
                if (state.logoImageBlobUrl) URL.revokeObjectURL(state.logoImageBlobUrl);
                state.logoImageBlobUrl = null;
                dom.logoUrlInput.value = '';
            }
            updatePreview();
        };
        reader.readAsDataURL(file);
    }
    
    async function handleUrl(url, type) {
        if (!url || !url.startsWith('http')) return;
        
        const isLoadingKey = type === 'main' ? 'isMainImageLoading' : 'isLogoLoading';
        const imageUrlKey = type === 'main' ? 'mainImageUrl' : 'logoImageUrl';
        const blobUrlKey = type === 'main' ? 'mainImageBlobUrl' : 'logoImageBlobUrl';
        const fileInput = type === 'main' ? dom.mainImageInput : dom.logoImageInput;

        state[isLoadingKey] = true;
        updatePreview();
        
        try {
            const response = await fetch(url, { mode: 'cors' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const blob = await response.blob();
            
            if (state[blobUrlKey]) { URL.revokeObjectURL(state[blobUrlKey]); }

            state[blobUrlKey] = URL.createObjectURL(blob);
            state[imageUrlKey] = ''; 
            fileInput.value = '';
        } catch (error) {
            console.error('Error fetching image:', error);
            alert('لم نتمكن من تحميل الصورة من الرابط. يرجى التأكد من صحة الرابط أو محاولة رابط آخر.');
            state[blobUrlKey] = null;
        } finally {
            state[isLoadingKey] = false;
            updatePreview();
        }
    }

    async function exportImage() {
        if (state.isExporting) return;
        state.isExporting = true;
        dom.exportButton.disabled = true;
        dom.exportButtonContent.classList.add('hidden');
        dom.exportButtonLoading.classList.remove('hidden');

        try {
            const canvas = await html2canvas(dom.imagePreview, { 
                useCORS: true, 
                allowTaint: true,
                scale: 2
            });
            const link = document.createElement('a');
            link.download = `news-short-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        } catch (error) {
            console.error("Error exporting image:", error);
            alert("حدث خطأ أثناء تصدير الصورة. يرجى المحاولة مرة أخرى.");
        } finally {
            state.isExporting = false;
            dom.exportButton.disabled = false;
            dom.exportButtonContent.classList.remove('hidden');
            dom.exportButtonLoading.classList.add('hidden');
        }
    }

    function renderPalettes() {
        dom.palettesContainer.innerHTML = palettes.map(p => `
            <button data-name="${p.name}" class="palette-btn ${p === state.activePalette ? 'active' : ''}">
              <div class="palette-color-box" style="background: ${p.css}"></div>
              <span>${p.name}</span>
            </button>
        `).join('');
    }

    function initializeInputs() {
        dom.headlineInput.value = state.headline;
        dom.newsBodyInput.value = state.newsBody;
        dom.fontFamilyInput.value = state.fontFamily;
        dom.headlineColorInput.value = state.headlineColor;
        dom.newsBodyColorInput.value = state.newsBodyColor;
        
        const rangeInputs = [
            { input: dom.headlineSizeInput, stateKey: 'headlineSize', label: dom.headlineSizeValue },
            { input: dom.newsBodySizeInput, stateKey: 'newsBodySize', label: dom.newsBodySizeValue },
            { input: dom.logoSizeInput, stateKey: 'logoSize', label: dom.logoSizeValue },
        ];
        rangeInputs.forEach(({input, stateKey, label}) => {
            if (input) {
                input.value = state[stateKey];
                if(label) label.textContent = state[stateKey];
            }
        });
    }
    
    function cleanup() {
        if (state.mainImageBlobUrl) URL.revokeObjectURL(state.mainImageBlobUrl);
        if (state.logoImageBlobUrl) URL.revokeObjectURL(state.logoImageBlobUrl);
    }

    initializeInputs();
    renderPalettes();
    setupEventListeners();
    updatePreview();
});
</script>
</body>
</html>
